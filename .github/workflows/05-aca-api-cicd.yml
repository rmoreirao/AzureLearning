name: 05-ACA-ToDo AKS Web App API-Build and deploy 
on:
  push:
    branches: [ "main" ]
    paths: 
      - '05-ContainerApps-Cosmos-GH/ToDoWebAppACA/ToDoWebApp.API/**'
      - '.github/workflows/05-aca-api-cicd.yml'
    
  workflow_dispatch:

env:
  rgName: rg-todoacawebapp-dev1-${{ secrets.AKS_05_LOCATION_SUFFIX }}

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout to the branch
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to container registry
        uses: docker/login-action@v1
        with:
          registry: ${{ secrets.05_ACR_LOGIN }}
          username: ${{ secrets.05_ACR_NAME }}
          password: ${{ secrets.05_ACR_PASSWORD }}

      - name: Build and push container image to registry
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: ${{ secrets.05_ACR_LOGIN }}/aca-api:${{ github.sha }} , ${{ secrets.05_ACR_LOGIN }}/aca-api:latest
          file: 05-ContainerApps-Cosmos-GH/ToDoWebAppACA/ToDoWebApp.API/Dockerfile
          context: 05-ContainerApps-Cosmos-GH/ToDoWebAppACA